name: Deploy to Aliyun

# 触发条件：当有代码推送到 main 分支时
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # 使用 GitHub 提供的最新 Linux 环境

    steps:
    # 1. 把你的代码从仓库拉下来
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. 准备 Node.js 环境 (Docusaurus 需要)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # 3. 安装依赖并生成静态文件 (打包)
    - name: Install and Build
      run: |
        npm ci
        npm run build

    # 4. 把打包好的 build 文件夹传到阿里云
    - name: Deploy to Aliyun Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "build/"           # 本地要上传的文件夹
        target: "/var/www/html"    # 服务器上的目标位置
        strip_components: 1        # 上传时去掉 build/ 这一层壳，直接把内容倒进去
